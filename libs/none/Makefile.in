
none_srcdir := $(srcdir)
none_objdir := $(objdir)

libs:: prefix/lib/libnone.a


NONE_ASM_FILES = UnwindRegistersRestore.S UnwindRegistersSave.S
NONE_ASM := $(addprefix $(none_srcdir)/,$(NONE_ASM_FILES))
NONE_OBJS := $(addprefix $(none_objdir)/,$(NONE_ASM_FILES:.S=.o))

$(none_objdir)/%.o: $(none_srcdir)/%.S $(none_srcdir)/assembly.h
	$(CC) $< -c -o $@ $(CFLAGS)

# Take existing musl libc.a and add our little libunwind bits.
prefix/lib/libnone.a: $(none_objdir)/musl-libc.a $(NONE_OBJS) | prefix/lib/.mkdir.done
	cp $< $@.tmp
	ar rs $@.tmp $(NONE_OBJS)
	mv $@.tmp $@

clean::
	rm -rf prefix/lib/libnone.a $(NONE_OBJS)

MUSL := musl-1.1.15

MUSL_PATCHES := $(wildcard $(none_srcdir)/musl-patches/*.patch)

# Update our copy if new one is built
$(none_objdir)/musl-libc.a: $(none_objdir)/$(MUSL)/lib/libc.a
	cp $< $@

%/$(MUSL)/lib/libc.a: %/$(MUSL)/config.mak
	$(MAKE) -C $*/$(MUSL)

.PRECIOUS: %/$(MUSL)/config.mak
%/$(MUSL)/config.mak: $(none_srcdir)/$(MUSL).tar.gz $(MUSL_PATCHES)
	tar xvf $< -C $*
	$(foreach p,$(MUSL_PATCHES),patch -p1 -d $*/$(MUSL) -i $(p);)
	cd $*/$(MUSL) && ./configure --enable-visibility --disable-shared CFLAGS="-mcmodel=small"

clean::
	rm -rf $(none_objdir)/$(MUSL) $(none_objdir)/musl-libc.a
