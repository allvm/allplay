

Nuke previous temp directory, if it exists,
extra care required since we drop permissions later:

RUN: chmod u+rwx -R %t || true
RUN: rm %t -rf
RUN: mkdir %t

RUN: llvm-as %p/Inputs/simplest.ll -o %t.bc
RUN: bc2allvm %t.bc -f -o %t/simple-allexe
RUN: ln -s %t/simple-allexe %t/simple-allexe-link

RUN: allplay functionhashes %t


Check handling of symbolic link loops in traversal:
RUN: mkdir -p %t/a/b/
RUN: ln -s %t/a %t/a/b/a
RUN: not allplay functionhashes %t
RUN: rm %t/a/b/a

Check broken symlinks:
RUN: ln -s /invalid/path/nope/nope %t/a/b/invalid

These should be skipped over, check:
RUNX: allplay functionhashes %t |& FileCheck %s --check-prefix BROKEN
BROKEN: invalid
BROKEN-SAME: broken symlink
RUN: rm %t/a/b/invalid

Check permissions problems
RUN: chmod a-rwx %t/a
RUN: allplay functionhashes %t |& FileCheck %s --check-prefix PERM
PERM: Permission denied

Try to leave things in a reasonable state,
without this the directory can't be rm -rf'd

RUN: chmod u+rwx -R %t || true
